import { NextRequest, NextResponse } from "next/server";

// ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ä¾å­˜ç—‡å°‚é–€ã®ç›¸è«‡AI
const SYSTEM_PROMPT = `ã‚ãªãŸã¯ã€Œgambleã‚„ã‚ã‚‹å›ã€ã§ã™ã€‚ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ä¾å­˜ç—‡ã«æ‚©ã‚€æ–¹ã€…ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€æ¸©ã‹ãè¦ªèº«ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

## ã‚ãªãŸã®å½¹å‰²
- ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ä¾å­˜ç—‡ã«é–¢ã™ã‚‹ç›¸è«‡ã«ã€å…±æ„Ÿçš„ã‹ã¤å°‚é–€çš„ã«å¯¾å¿œã™ã‚‹
- åŒ»ç™‚è¡Œç‚ºã¯è¡Œã‚ãšã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å°‚é–€åŒ»ã¸ã®ç›¸è«‡ã‚’å‹§ã‚ã‚‹
- ç›¸è«‡è€…ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€å‰å‘ããªã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã™ã‚‹

## å¯¾å¿œæ–¹é‡
1. **å…±æ„Ÿã¨å‚¾è´**: ã¾ãšç›¸è«‡è€…ã®æ°—æŒã¡ã‚’å—ã‘æ­¢ã‚ã€å…±æ„Ÿã™ã‚‹
2. **éåˆ¤æ–­çš„æ…‹åº¦**: è²¬ã‚ãŸã‚Šèª¬æ•™ã—ãŸã‚Šã›ãšã€ç†è§£ã‚’ç¤ºã™
3. **å…·ä½“çš„ãªææ¡ˆ**: å®Ÿè·µå¯èƒ½ãªå°ã•ãªä¸€æ­©ã‚’ææ¡ˆã™ã‚‹
4. **é©åˆ‡ãªç´¹ä»‹**: å¿…è¦ã«å¿œã˜ã¦ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯(/check)ã‚„äºˆç´„(/book)ã‚’æ¡ˆå†…

## è©±ã—æ–¹
- è¦ªã—ã¿ã‚„ã™ãã€æ¸©ã‹ã„å£èª¿
- å°‚é–€ç”¨èªã¯é¿ã‘ã€ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§
- çŸ­ã‚ã®æ–‡ç« ã§ã€èª­ã¿ã‚„ã™ã
- çµµæ–‡å­—ã¯æ§ãˆã‚ã«ä½¿ç”¨

## é‡è¦ãªæ³¨æ„ç‚¹
- åŒ»ç™‚è¨ºæ–­ã‚„æ²»ç™‚ã¯è¡Œã‚ãªã„
- ç·Šæ€¥æ€§ãŒé«˜ã„å ´åˆã¯é€Ÿã‚„ã‹ã«å°‚é–€åŒ»ã‚„ç›¸è«‡çª“å£ã‚’æ¡ˆå†…
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«é…æ…®ã—ã€ç›¸è«‡å†…å®¹ã¯æ©Ÿå¯†ã¨ã—ã¦æ‰±ã†
- ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ä¾å­˜ç—‡ã¯ç—…æ°—ã§ã‚ã‚Šã€æ„å¿—ã®å¼±ã•ã§ã¯ãªã„ã“ã¨ã‚’ä¼ãˆã‚‹

## ã‚ˆãã‚ã‚‹ç›¸è«‡ã¸ã®å¯¾å¿œä¾‹
- **ã€Œã‚„ã‚ã‚‰ã‚Œãªã„ã€**: ä¾å­˜ç—‡ã¯ç—…æ°—ã§ã‚ã‚Šã€ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªãã¦è‰¯ã„ã“ã¨ã‚’ä¼ãˆã‚‹
- **ã€Œå€Ÿé‡‘ãŒã‚ã‚‹ã€**: å¸æ³•æ›¸å£«ã‚„å¼è­·å£«ã¸ã®ç›¸è«‡ã‚’å‹§ã‚ã‚‹
- **ã€Œå®¶æ—ã«çŸ¥ã‚‰ã‚ŒãŸããªã„ã€**: å®ˆç§˜ç¾©å‹™ã¨åŒ¿åç›¸è«‡ã®å¯èƒ½æ€§ã‚’èª¬æ˜
- **ã€Œä½•ã‹ã‚‰å§‹ã‚ã‚Œã°ã€**: ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã‚„å°‚é–€åŒ»ã¸ã®ç›¸è«‡ã‚’ææ¡ˆ`;

// ãƒ‡ãƒ¢ç’°å¢ƒç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
function generateMockResponse(userMessage: string): string {
  const lowerMessage = userMessage.toLowerCase();

  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“å¿œç­”
  if (lowerMessage.includes("ã‚„ã‚ã‚‰ã‚Œãªã„") || lowerMessage.includes("æ­¢ã‚ã‚‰ã‚Œãªã„")) {
    return "ãŠè©±ã‚’èã‹ã›ã¦ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã‚’ã‚„ã‚ãŸã„ã®ã«ã‚„ã‚ã‚‰ã‚Œãªã„ã€ãã®è‹¦ã—ã•ã¯æœ¬å½“ã«ãŠã¤ã‚‰ã„ã§ã™ã‚ˆã­ã€‚\n\nã‚®ãƒ£ãƒ³ãƒ–ãƒ«ä¾å­˜ç—‡ã¯æ„å¿—ã®å¼±ã•ã§ã¯ãªãã€è„³ã®ç—…æ°—ã§ã™ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãšã€å°‚é–€å®¶ã«ç›¸è«‡ã™ã‚‹ã“ã¨ãŒå›å¾©ã¸ã®ç¬¬ä¸€æ­©ã«ãªã‚Šã¾ã™ã€‚\n\nå½“ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ã¯ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§æ°—è»½ã«ç›¸è«‡ã§ãã‚‹ç’°å¢ƒã‚’æ•´ãˆã¦ã„ã¾ã™ã€‚ã¾ãšã¯ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ";
  }

  if (lowerMessage.includes("å€Ÿé‡‘") || lowerMessage.includes("ãŠé‡‘")) {
    return "é‡‘éŠ­çš„ãªå•é¡Œã‚’æŠ±ãˆã¦ã„ã‚‰ã£ã—ã‚ƒã‚‹ã®ã§ã™ã­ã€‚ã¨ã¦ã‚‚ä¸å®‰ãªãŠæ°—æŒã¡ã ã¨æ€ã„ã¾ã™ã€‚\n\nã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã«ã‚ˆã‚‹å€Ÿé‡‘å•é¡Œã¯ã€å°‚é–€å®¶ã®ã‚µãƒãƒ¼ãƒˆã§è§£æ±ºã§ãã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚å¸æ³•æ›¸å£«ã‚„å¼è­·å£«ã«ç›¸è«‡ã™ã‚‹ã“ã¨ã§ã€å‚µå‹™æ•´ç†ãªã©ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚\n\nå½“ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ã‚‚ã€å¿…è¦ã«å¿œã˜ã¦å°‚é–€æ©Ÿé–¢ã‚’ã”ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ã¾ãšã¯ç¾çŠ¶ã‚’æ•´ç†ã™ã‚‹ãŸã‚ã€ä¸€åº¦ã”ç›¸è«‡ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ";
  }

  if (lowerMessage.includes("å®¶æ—") || lowerMessage.includes("å¦»") || lowerMessage.includes("å¤«")) {
    return "ã”å®¶æ—ã¨ã®é–¢ä¿‚ã§ãŠæ‚©ã¿ãªã®ã§ã™ã­ã€‚ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ä¾å­˜ç—‡ã¯æœ¬äººã ã‘ã§ãªãã€ã”å®¶æ—ã‚‚å¤§ããªå½±éŸ¿ã‚’å—ã‘ã¾ã™ã€‚\n\nå½“ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ã¯ã€ã”æœ¬äººã ã‘ã§ãªãã”å®¶æ—ã®æ–¹ã‹ã‚‰ã®ç›¸è«‡ã‚‚å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ã€‚ã”å®¶æ—ã¨ä¸€ç·’ã«å›å¾©ã‚’ç›®æŒ‡ã™ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚‚ã”ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚\n\nä¸€äººã§æŠ±ãˆè¾¼ã¾ãšã€ã¾ãšã¯ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚";
  }

  if (lowerMessage.includes("äºˆç´„") || lowerMessage.includes("è¨ºå¯Ÿ")) {
    return "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¨ºç™‚ã®ã”äºˆç´„ã«èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nå½“ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ã¯ã€ã”è‡ªå®…ã‹ã‚‰å®‰å¿ƒã—ã¦è¨ºç™‚ã‚’å—ã‘ã‚‰ã‚Œã‚‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¨ºç™‚ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚æµ¦æ±Ÿæ™‹å¹³åŒ»å¸«ãŒã€ãŠä¸€äººãŠä¸€äººã«å¯„ã‚Šæ·»ã£ãŸè¨ºç™‚ã‚’è¡Œã„ã¾ã™ã€‚\n\näºˆç´„ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ã”éƒ½åˆã®è‰¯ã„æ—¥æ™‚ã‚’ãŠé¸ã³ã„ãŸã ã‘ã¾ã™ã€‚ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠå°‹ã­ãã ã•ã„ã€‚";
  }

  if (lowerMessage.includes("æ–™é‡‘") || lowerMessage.includes("è²»ç”¨")) {
    return "æ–™é‡‘ã«ã¤ã„ã¦ã®ã”è³ªå•ã§ã™ã­ã€‚\n\nåˆè¨ºã¯8,800å††ã€å†è¨ºã¯5,500å††ã‚’ç›®å®‰ã¨ã—ã¦ã„ã¾ã™ã€‚ä¿é™ºé©ç”¨å¤–ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¨ºç™‚ã¨ãªã‚Šã¾ã™ãŒã€ã”è‡ªå®…ã‹ã‚‰å—è¨ºã§ãã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚\n\nè©³ã—ã„æ–™é‡‘ã«ã¤ã„ã¦ã¯ã€æ–™é‡‘ãƒšãƒ¼ã‚¸ã‚’ã”ç¢ºèªã„ãŸã ãã‹ã€äºˆç´„æ™‚ã«ã”æ¡ˆå†…ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚";
  }

  if (lowerMessage.includes("ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯") || lowerMessage.includes("ãƒã‚§ãƒƒã‚¯")) {
    return "ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ã¯ã€ç¾åœ¨ã®çŠ¶æ…‹ã‚’å®¢è¦³çš„ã«æŠŠæ¡ã™ã‚‹è‰¯ã„æ–¹æ³•ã§ã™ã€‚\n\n7ã¤ã®è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€ã‚®ãƒ£ãƒ³ãƒ–ãƒ«å•é¡Œã®ãƒªã‚¹ã‚¯ã‚’ç°¡æ˜“åˆ¤å®šã§ãã¾ã™ã€‚çµæœã¯å®‰å…¨ã«ä¿ç®¡ã•ã‚Œã€è¨ºç™‚æ™‚ã®å‚è€ƒè³‡æ–™ã¨ã—ã¦ã‚‚æ´»ç”¨ã§ãã¾ã™ã€‚\n\nã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ãœã²ãŠè©¦ã—ãã ã•ã„ã€‚";
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹
  return "ãŠè©±ã‚’èã‹ã›ã¦ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\nã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã«é–¢ã™ã‚‹ãŠæ‚©ã¿ã¯ã€ä¸€äººã§æŠ±ãˆè¾¼ã¾ãšç›¸è«‡ã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚å½“ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã§ã¯ã€å°‚é–€åŒ»ãŒè¦ªèº«ã«ãªã£ã¦ã‚µãƒãƒ¼ãƒˆã„ãŸã—ã¾ã™ã€‚\n\nå…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªã“ã¨ã§ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨ã€ã‚ˆã‚Šé©åˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚";
}

export async function POST(req: NextRequest) {
  try {
    const { messages } = await req.json();

    if (!messages || !Array.isArray(messages)) {
      return NextResponse.json(
        { error: "Invalid request" },
        { status: 400 }
      );
    }

    // æœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    const lastUserMessage = messages
      .filter((m: { role: string }) => m.role === "user")
      .pop()?.content || "";

    // ãƒ‡ãƒ¢ç’°å¢ƒç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    const mockResponse = generateMockResponse(lastUserMessage);

    // æœ¬ç•ªç’°å¢ƒã§ã¯ã€ã“ã“ã§OpenAI APIã‚’å‘¼ã³å‡ºã™
    // const openaiResponse = await fetch("https://api.openai.com/v1/chat/completions", {
    //   method: "POST",
    //   headers: {
    //     "Content-Type": "application/json",
    //     "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
    //   },
    //   body: JSON.stringify({
    //     model: "gpt-4",
    //     messages: [
    //       { role: "system", content: SYSTEM_PROMPT },
    //       ...messages
    //     ],
    //     temperature: 0.7,
    //     max_tokens: 500
    //   })
    // });

    console.log("\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("ğŸ’¬ [DEMO] gambleã‚„ã‚ã‚‹å› ãƒãƒ£ãƒƒãƒˆ");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${lastUserMessage}`);
    console.log(`ğŸ¤– AIå¿œç­”: ${mockResponse}`);
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    return NextResponse.json({
      message: mockResponse
    });
  } catch (error) {
    console.error("Chat API error:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
